<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>FinanceSim â€“ Sell Assets</title>
  <link rel="stylesheet" href="homestyle.css">
</head>
<body>
  <nav class="nav">
    <div class="brand">FinanceSim</div>
    <div class="nav-links">
      <a href="index.html">Home</a>
      <a href="buyPage.html">Investment Hub</a>
    </div>
  </nav>

  <div class="container">
    <div class="summary">
      <div class="item">Year: <span id="current-year" class="val">2020</span></div>
      <div class="item">Cash: $<span id="cash-amount" class="val">0.00</span></div>
    </div>

    <h1>Your Investments</h1>
    <div class="panel">
      <p style="margin:0 0 8px;">Select which assets you want to sell.</p>
      <table class="table">
        <thead>
          <tr>
            <th>Type</th>
            <th>Name</th>
            <th>Quantity / Balance</th>
            <th>Current Value</th>
            <th>Action</th>
          </tr>
        </thead>
        <tbody id="assets-body">
          <!-- Savings Account -->
          <tr>
            <td>Savings Account</td>
            <td>High Yield Savings</td>
            <td id="savings-qty">$0.00</td>
            <td id="savings-value">$0.00</td>
            <td><button class="btn btn-success" id="withdraw-btn">Withdraw</button></td>
          </tr>
        </tbody>
      </table>

      <div class="row" style="justify-content:space-between; margin-top:12px;">
        <button class="btn btn-secondary" onclick="window.location.href='buyPage.html'">Investment Hub</button>
        <button id="next-or-finalize-btn" class="btn btn-primary">Next Year</button>
      </div>
    </div>
  </div>

  <!-- Withdraw Modal -->
  <div id="withdraw-modal" class="popup">
    <div class="popup-content">
      <span class="close" id="cancel-withdraw">&times;</span>
      <h2>Withdraw from Savings</h2>
      <p>Enter amount to withdraw:</p>
      <input type="number" id="withdraw-amount" min="0.01" step="0.01" value="1000.00" class="input" style="width: 80%;" />
      <div class="row" style="margin-top:12px;">
        <button id="confirm-withdraw" class="btn btn-success">Confirm</button>
        <button id="cancel-withdraw-2" class="btn btn-secondary">Cancel</button>
      </div>
      <p id="withdraw-error" style="color: var(--danger); margin-top:10px; display:none;"></p>
    </div>
  </div>

  <script>
    // ======= Elements =======
    const withdrawBtn = document.getElementById('withdraw-btn');
    const modal = document.getElementById('withdraw-modal');
    const confirmBtn = document.getElementById('confirm-withdraw');
    const cancelBtnX = document.getElementById('cancel-withdraw');
    const cancelBtn = document.getElementById('cancel-withdraw-2');
    const withdrawInput = document.getElementById('withdraw-amount');
    const cashAmount = document.getElementById('cash-amount');
    const savingsValue = document.getElementById('savings-value');
    const savingsQty = document.getElementById('savings-qty');
    const errorMsg = document.getElementById('withdraw-error');
    const yearSpan = document.getElementById('current-year');
    const nextOrFinalizeBtn = document.getElementById('next-or-finalize-btn');
    const assetsBody = document.getElementById('assets-body');

    // ======= State =======
    const interestRate = 0.004;
    let cash = 0.00;
    let savings = 0.00;
    let year = 2020;
    let companies = [];

    function formatMoney(val) {
      return (val ?? 0).toLocaleString(undefined,{minimumFractionDigits:2, maximumFractionDigits:2});
    }

    function loadData() {
      cash = parseFloat(localStorage.getItem("balance")) || 10000;
      savings = parseFloat(localStorage.getItem("savings")) || 0;
      year = parseInt(localStorage.getItem("year")) || 2020;
      const savedCompanies = JSON.parse(localStorage.getItem("companies")) || [];
      companies = savedCompanies.map(c => ({ ...c })); // clone

      cashAmount.textContent = formatMoney(cash);
      savingsValue.textContent = "$" + formatMoney(savings);
      savingsQty.textContent = "$" + formatMoney(savings);
      yearSpan.textContent = year;

      renderStocks();
      updateNextOrFinalize();
    }

    function saveData() {
      localStorage.setItem("balance", cash);
      localStorage.setItem("savings", savings);
      localStorage.setItem("year", year);
      localStorage.setItem("companies", JSON.stringify(companies));
    }

    // ======= Savings Withdraw =======
    function showModal() { modal.classList.add('show'); }
    function hideModal() { modal.classList.remove('show'); }

    withdrawBtn.onclick = () => {
      withdrawInput.value = 1000.00;
      withdrawInput.max = savings;
      errorMsg.style.display = 'none';
      showModal();
    };
    cancelBtn.onclick = hideModal;
    cancelBtnX.onclick = hideModal;

    confirmBtn.onclick = () => {
      const amtStr = withdrawInput.value.trim();
      const amt = parseFloat(amtStr);
      if (!/^\d+(\.\d{1,2})?$/.test(amtStr)) { errorMsg.textContent = 'Use at most 2 decimals.'; errorMsg.style.display = 'block'; return; }
      if (isNaN(amt) || amt < 0.01) { errorMsg.textContent = 'Invalid amount.'; errorMsg.style.display = 'block'; return; }
      if (amt > savings) { errorMsg.textContent = 'Cannot withdraw more than savings.'; errorMsg.style.display = 'block'; return; }

      savings -= amt; cash += amt;
      saveData();
      hideModal();
      loadData();
    };

    // ======= Stocks Sell Logic =======
    function renderStocks() {
      // remove old stock rows
      Array.from(assetsBody.querySelectorAll('.stock-row')).forEach(el => el.remove());
      companies.forEach((c, idx) => {
        if (c.value <= 0) return; // skip companies with no investment
        const tr = document.createElement('tr');
        tr.classList.add('stock-row');
        tr.innerHTML = `
          <td>Stock</td>
          <td>${c.name}</td>
          <td>$${formatMoney(c.value)}</td>
          <td>$${formatMoney(c.value)}</td>
          <td><button class="btn btn-success" onclick="sellStock(${idx})">Sell</button></td>
        `;
        assetsBody.appendChild(tr);
      });
    }

    function sellStock(idx) {
      const amount = companies[idx].value;
      if (amount <= 0) return;
      cash += amount;
      companies[idx].value = 0;
      saveData();
      loadData();
    }

    // ======= Next Year / Finalize =======
    function nextYear() {
      if (year >= 2025) return;
      year++;
      savings += savings * interestRate;
      // apply stock growth
      companies.forEach(c => c.value += c.value * (c.returnRate || 0));
      saveData();
      loadData();
    }

    function updateNextOrFinalize() {
      if (year >= 2025) {
        nextOrFinalizeBtn.textContent = "Calculate Total Assets";
        nextOrFinalizeBtn.onclick = () => {
          const totalAssets = Number((cash + savings + companies.reduce((sum,c)=>sum+c.value,0)).toFixed(2));
          localStorage.setItem('finalGrowth', totalAssets);
          window.location.href = 'end.html';
        };
      } else {
        nextOrFinalizeBtn.textContent = "Next Year";
        nextOrFinalizeBtn.onclick = nextYear;
      }
    }

    // ======= Init =======
    loadData();
  </script>
</body>
</html>
